@model IEnumerable<GamarraPlus.Models.Producto>

@{
    ViewData["Title"] = "Productos";
}

<h1>Productos</h1>

<p>
    <button class="btn btn-primary" onclick="openCreateModal()">Create New</button>
</p>

<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>@Html.DisplayNameFor(model => model.IdProducto)</th>
                <th>@Html.DisplayNameFor(model => model.Codigo)</th>
                <th>@Html.DisplayNameFor(model => model.Descripcion)</th>
                <th>@Html.DisplayNameFor(model => model.oCategoria.Descripcion)</th>
                <th>@Html.DisplayNameFor(model => model.PrecioCompra)</th>
                <th>@Html.DisplayNameFor(model => model.PrecioVenta)</th>
                <th>@Html.DisplayNameFor(model => model.Stock)</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@Html.DisplayFor(modelItem => item.IdProducto)</td>
                    <td>@Html.DisplayFor(modelItem => item.Codigo)</td>
                    <td>@Html.DisplayFor(modelItem => item.Descripcion)</td>
                    <td>@Html.DisplayFor(modelItem => item.oCategoria.Descripcion)</td>
                    <td>@Html.DisplayFor(modelItem => item.PrecioCompra)</td>
                    <td>@Html.DisplayFor(modelItem => item.PrecioVenta)</td>
                    <td>@Html.DisplayFor(modelItem => item.Stock)</td>
                    <td>
                        <a class="btn btn-primary" onclick="openEditModal('@item.IdProducto', '@item.Codigo', '@item.Descripcion', '@item.PrecioCompra', '@item.PrecioVenta', '@item.Stock', '@item.oCategoria.Descripcion')">Edit</a> |
                        <button class="btn btn-danger" onclick="confirmDelete('@item.IdProducto', '@item.Descripcion')">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Modal para la edición o creación de un producto -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarLabel">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario de edición o creación del producto -->
                <form id="formEditarProducto">
                    <div class="mb-3">
                        <label for="inputCodigo" class="form-label">Code</label>
                        <input type="text" class="form-control" id="inputCodigo" name="codigo">
                    </div>
                    <div class="mb-3">
                        <label for="inputDescripcion" class="form-label">Description</label>
                        <input type="text" class="form-control" id="inputDescripcion" name="descripcion">
                    </div>
                    <div class="mb-3">
                        <label for="selectCategoria" class="form-label">Category</label>
                        <select class="form-control" id="selectCategoria" name="categoria">
                            @foreach (var categoria in ViewBag.Categorias)
                            {
                                <option value="@categoria.IdCategoria">@categoria.Descripcion</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="inputPrecioCompra" class="form-label">Purchase Price</label>
                        <input type="number" class="form-control" id="inputPrecioCompra" name="precioCompra">
                    </div>
                    <div class="mb-3">
                        <label for="inputPrecioVenta" class="form-label">Sale Price</label>
                        <input type="number" class="form-control" id="inputPrecioVenta" name="precioVenta">
                    </div>
                    <div class="mb-3">
                        <label for="inputStock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="inputStock" name="stock">
                    </div>
                    <input type="hidden" id="inputIdProducto" name="idProducto">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="EditarProducto()">Save changes</button>
            </div>
        </div>
    </div>
</div>



<!-- Modal para la creación de un nuevo producto -->
<div class="modal fade" id="modalCrear" tabindex="-1" aria-labelledby="modalCrearLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCrearLabel">Create New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario para crear un nuevo producto -->
                <form id="formCrearProducto">
                    <div class="mb-3">
                        <label for="inputNuevoCodigo" class="form-label">Code</label>
                        <input type="text" class="form-control" id="inputNuevoCodigo" name="nuevoCodigo">
                    </div>
                    <div class="mb-3">
                        <label for="inputNuevaDescripcion" class="form-label">Description</label>
                        <input type="text" class="form-control" id="inputNuevaDescripcion" name="nuevaDescripcion">
                    </div>
                    <div class="mb-3">
                        <label for="selectNuevaCategoria" class="form-label">Category</label>
                        <select class="form-control" id="selectNuevaCategoria" name="idCategoria">
                            @foreach (var categoria in ViewBag.Categorias)
                            {
                                <option value="@categoria.IdCategoria">@categoria.Descripcion</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="inputNuevoPrecioCompra" class="form-label">Purchase Price</label>
                        <input type="number" class="form-control" id="inputNuevoPrecioCompra" name="nuevoPrecioCompra">
                    </div>
                    <div class="mb-3">
                        <label for="inputNuevoPrecioVenta" class="form-label">Sale Price</label>
                        <input type="number" class="form-control" id="inputNuevoPrecioVenta" name="nuevoPrecioVenta">
                    </div>
                    <div class="mb-3">
                        <label for="inputNuevoStock" class="form-label">Stock</label>
                        <input type="number" class="form-control" id="inputNuevoStock" name="nuevoStock">
                    </div>
                </form>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="CrearProducto()">Create</button>
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


<script>
    // Obtener la lista de categorías del ViewBag y serializarla
    var categorias = @Json.Serialize(ViewBag.Categorias);

    // Obtener el select por su ID
    var selectNuevaCategoria = document.getElementById('selectNuevaCategoria');

    // Iterar sobre las categorías y agregar opciones al select
    categorias.forEach(function (categoria) {
        var option = document.createElement('option');
        option.value = categoria.Value;
        option.textContent = categoria.Text;
        selectNuevaCategoria.appendChild(option);
    });
</script>

<script>
    function confirmDelete(idProducto, descripcion) {
        Swal.fire({
            title: 'Are you sure?',
            text: `You are about to delete product with ID ${idProducto} (${descripcion}). This action cannot be undone!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // If the user confirms deletion
                deleteProducto(idProducto);
            }
        });
    }

    async function deleteProducto(idProducto) {
        try {
            const response = await fetch(`/Inventario/EliminarProducto?idProducto=${idProducto}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                // Close the confirmation alert
                Swal.fire({
                    title: 'Deleted!',
                    text: 'The product has been deleted.',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1500
                });
                // Reload the page after successful deletion
                location.reload();
            } else {
                throw new Error('Failed to delete product!');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.message || 'Failed to delete product!'
            });
        }
    }

    function openEditModal(idProducto, codigo, descripcion, precioCompra, precioVenta, stock, categoria) {
        $('#inputIdProducto').val(idProducto);
        $('#inputCodigo').val(codigo);
        $('#inputDescripcion').val(descripcion);
        $('#inputPrecioCompra').val(precioCompra);
        $('#inputPrecioVenta').val(precioVenta);
        $('#inputStock').val(stock);

        // Set the category ID and select the corresponding option
        $('#selectCategoria').val(categoria);

        // Update the selected option based on the category value
        $('#selectCategoria option').filter(function () {
            return $(this).text() === categoria;
        }).prop('selected', true);

        $('#modalEditarLabel').text('Edit Product');
        $('#modalEditar').modal('show');
    }




    // Function to send changes to the server when clicking on the "Save changes" button
    async function EditarProducto() {
        var idProducto = $('#inputIdProducto').val();
        var nuevoCodigo = $('#inputCodigo').val();
        var nuevaDescripcion = $('#inputDescripcion').val();
        var nuevoPrecioCompra = $('#inputPrecioCompra').val();
        var nuevoPrecioVenta = $('#inputPrecioVenta').val();
        var nuevoStock = $('#inputStock').val();
        var categoria = $('#selectCategoria').val(); // Get the selected category ID

        try {
            const response = await fetch(`/Inventario/ActualizarProducto`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    idProducto: idProducto,
                    codigo: nuevoCodigo,
                    descripcion: nuevaDescripcion,
                    precioCompra: nuevoPrecioCompra,
                    precioVenta: nuevoPrecioVenta,
                    stock: nuevoStock,
                    oCategoria: {
                        IdCategoria: categoria,
                        Descripcion: $('#selectNuevaCategoria option:selected').text() // Send the selected category description as well
                    }
                })
            });

            if (response.ok) {
                // If the response is successful, show a success message and reload the page
                Swal.fire({
                    title: 'Saved!',
                    text: 'The product has been updated.',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1500
                });
                location.reload();
            } else {
                throw new Error('Failed to save product!');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.message || 'Failed to save product!'
            });
        }
    }

</script>

<script>
    // Function to open the modal for creating a new product
    function openCreateModal() {
        $('#inputNuevoCodigo').val('');
        $('#inputNuevaDescripcion').val('');
        $('#inputNuevoPrecioCompra').val('');
        $('#inputNuevoPrecioVenta').val('');
        $('#inputNuevoStock').val('');
        $('#selectNuevaCategoria').val(''); // Clear the selected category
        $('#modalCrearLabel').text('Create New Product');
        $('#modalCrear').modal('show');
    }

    async function CrearProducto() {
        var nuevoCodigo = $('#inputNuevoCodigo').val();
        var nuevaDescripcion = $('#inputNuevaDescripcion').val();
        var nuevoPrecioCompra = $('#inputNuevoPrecioCompra').val();
        var nuevoPrecioVenta = $('#inputNuevoPrecioVenta').val();
        var nuevoStock = $('#inputNuevoStock').val();
        var idCategoria = $('#selectNuevaCategoria').val(); // Get the selected category ID

        try {
            const response = await fetch(`/Inventario/GuardarProducto`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    Codigo: nuevoCodigo,
                    Descripcion: nuevaDescripcion,
                    PrecioCompra: nuevoPrecioCompra,
                    PrecioVenta: nuevoPrecioVenta,
                    Stock: nuevoStock,
                    oCategoria: {
                        IdCategoria: idCategoria,
                        Descripcion: $('#selectNuevaCategoria option:selected').text() // Send the selected category description as well
                    }
                })
            });

            if (response.ok) {
                // If the response is successful, show a success message and reload the page
                Swal.fire({
                    title: 'Created!',
                    text: 'The product has been created.',
                    icon: 'success',
                    showConfirmButton: false,
                    timer: 1500
                });
                location.reload();
            } else {
                throw new Error('Failed to create product!');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: error.message || 'Failed to create product!'
            });
        }
    }
</script>


